<!DOCTYPE html>

<html>
<head>
  <title>Presentation</title>
  <meta charset='utf-8'>
  <script src='http://html5slides.googlecode.com/svn/trunk/slides.js'></script>
</head>

<body style='display: none'>
<section class='slides layout-regular '>
  <article>
    <h1>
      Kvalitet i JavaScript
    </h1>

    <p>
      Christian Schwarz og Lars Brandt
      <br>
      26 August 2011
    </p>
  </article>
  <article>
    <h3>
      Agenda
    </h3>
    <ul>
      <li>
        Hvorfor gjøre noe annet enn vi gjør i dag?
      </li>
      <li>
        JavaScript fundamenter
      </li>
      <li>
        Nyttige hjelpere
      </li>
      <li>
        Testing
      </li>
      <li>
        Eksempel: Ajax
      </li>
      <li>
        Eksempel: Controller + View
      </li>
      <li>
        Lesson learned
      </li>
    </ul>
  </article>

  <article class='smaller'>
    <h3>
      Bring booking
    </h3>

    <p>
      <img style='width: 100%' src="http://i.imgur.com/uVFd7.png"/>
    </p>
  </article>

  <article class='smaller'>
    <h3>
      Hvorfor gjøre noe annet enn vi gjør i dag?
    </h3>

    <p>
      PackageDetails anno 06.09.2010
    </p><br/>

    <p>
      <img style='width: 100%' src='http://i.imgur.com/v5gnu.png'>
    </p>
  </article>

  <article class='smaller'>
    <h3>
      Hvorfor gjøre noe annet enn vi gjør i dag?
    </h3>

    <p>
      PackageDetails anno 22.09.2010
    </p><br/>

    <p>
      <img style='width: 100%' src='http://i.imgur.com/JnBT1.png'>
    </p>
  </article>

  <article class='smaller'>
    <h3>
      Hvorfor gjøre noe annet enn vi gjør i dag?
    </h3>

    <p>
      PackageDetails anno 01.12.2010
    </p><br/>

    <p>
      <img style='width: 100%' src='http://i.imgur.com/RM4Jr.png'>
    </p>
  </article>

  <article>
    <h3>
      Hvorfor gjøre noe annet enn vi gjør i dag?
    </h3>
    <ul>
      <li>
        Koden er vanskelig å gjenbruke
      </li>
      <li>
        Vanskelig å teste
      </li>
      <li>
        Ingen klar kodestandard
      </li>
      <li>
        Dårlig kvalitet
        <ul style="font-size: 22px">
          <li>Har mer bugs i JavaScript enn i Java selv om det bare utgjør 14% av kodebasen</li>
          <img src='http://i.imgur.com/Dy3Pc.png'>
        </ul>
      </li>
      <li>
        Utfordrende og forbedre/refaktorere koden
      </li>
    </ul>
  </article>

  <article>
    <h3>
      Hva ønsket vi oss?
    </h3>
    <ul>
      <li>
        Ønsket å skrive tester slik vi gjorde med resten av koden
      </li>
      <li>
        Testene måtte kjøre som en del av bygget
      </li>
      <li>
        Forstå JavaScript og heve kvaliteten på koden
      </li>
    </ul>
  </article>

  <article>
    <h1>
      JavaScript fundamenter
    </h1>
  </article>

  <article>
    <h3>
      JavaScript fundamenter
    </h3>
    <ul>
      <li>
        Simple types
      </li>
      <ul style="font-size: 22px">
        <li>Numbers</li>
        <li>Strings</li>
        <li>Booleans</li>
      </ul>
      <li>
        Alt annet er objekter
      </li>
    </ul>
  </article>

  <article>
    <h3>
      Objekter
    </h3>
    <ul>
      <li>
        Samling av properties (key / value)
      </li>
      <ul style="font-size: 22px">
        <li>
          Keys er strings
        </li>
        <li>
          Values er primitiver eller objekter
        </li>
      </ul>
    </ul>
  <pre>
  //anonymt objekt:
  {
    name : "Per",
    age : 32,
    greet : function() { alert("Hei"); }
  }</pre>
    <ul>
      <li>
        Kan legge inn / modifisere properties fra hvor som helst
      </li>
    </ul>
  </article>

  <article>
    <h3>
      Objekter har link til en prototype
    </h3>
    <ul>
      <li>
        Mekanisme for gjenbruk av funksjonalitet
      </li>
      <li>
        Delegering
      </li>
      <ul style="font-size: 22px">
        <li>
          Property mangler -> prøver prototype’n
        </li>
        <li>
          Hierarki
        </li>
        <li>
          "En streng" har String.prototype som prototype
        </li>
        <li>
          function() {} har Function.prototype som prototype<br/>
        </li>
        <li>
          Alle objekter har default Object.prototype som rot-prototype
        </li>
        <li>
          Ting som legges i prototyper er umiddelbart tilgjengelig for alle som peker til den
        </li>
      </ul>
    </ul>
  </article>

  <article>
    <h3>
      Hierarki ("Prototype chain")
    </h3>
    <br/>
    <br/>
    <img src="http://i.imgur.com/1V2Ld.png" alt="Prototype chain" width="110%"/>
    <br/>
    <p>Property aksess: Traverserer prototype chain til property lokaliseres...</p>
  </article>


  <article>
    <h3>
      Funksjoner
    </h3>
    <ul>
      <li>
        Er objekter
      </li>
      <ul style="font-size: 22px">
        <li>
          Dvs. kan inneholde properties
        </li>
        <li>
          Kan tilordnes variable og sendes som argumenter
        </li>
      </ul>
      <li>
        Inneholder en kodeblokk
      </li>
      <ul style="font-size: 22px">
        <li>
          private variable, statements, expressions, ...
        </li>
      </ul>
      <li>
        Kan ha navn (for rekursivitet + debugging)
      </li>
    </ul>
    <pre>
  function foo() {}  //navngitt funksjon

  var foo = function foo() {}  //samme som den over

  function() {}   //anonym funksjon
    </pre>
  </article>

  <article>
    <h3>
      Opprette objekter - Legge på properties
    </h3>
    <pre>
  var circle = {};
  circle.radius = 1;
  circle.area = function() { return this.radius * ... }

  var area = circle.area();

  //kan bytte ut public funksjon:
  circle.area = function() { alert("hei"); }
    </pre>
  </article>

  <article>
      <h3>
        Opprette objekter - Object literal
      </h3>
      <pre>
  var circle = {
     radius : 1,
     area : function() { return this.radius * ... }
  };
  var area = circle.area();

  //legg merke til “:” og “,”
      </pre>
  </article>

  <article>
    <h3>
      Opprette objekter med privat state - Closures
    </h3>
    <ul>
      <pre>
function circle() {
  var radius = 1;
  return {
    area : function() { return radius * radius * 3.14 }
  }
}

//radius er privat / beskyttet
//radius lever videre etter returnert funksjon (“free variable”)

alert(circle().area());
      </pre>
      <script type="text/javascript">
        function circle() {
          var radius = 1;
          return {
            area : function() { return radius * radius * 3.14 }
          }
        }
      </script>
    </pre>
    <button style="font-size: 28px;" onclick="alert(circle().area()); return false;">Prøv!</button>

    </ul>
  </article>
  <article>
    <h3>
      Opprette objekter - Construktor funksjon
    </h3>
    <pre>
  function Circle() {
    this.radius = 1;
    this.area = function() { return this.radius * ... };
  }
  var area = new Circle().area();

  //Navnekonvensjon: Stor forbokstav
      
  //Må huske “new” ellers defineres globale variable!
    </pre>
  </article>

  <article>
    <h3>
      Construktor funksjon med guard
    </h3>
    <pre>
  function Circle() {

    //guard against missing "new":
    if (!(this instanceof Circle)) {
      return new Circle();
    }

    this.radius = 1;
    this.area = function() { return this.radius * ... };
  }
    </pre>
  </article>

  <article>
    <h3>
      Tilganger / scope 
    </h3>
    <ul>
      <li>
        Variable har function scope
      </li>
      <li>
        Variable / funksjoner utenfor en funksjon har global scope
      </li>
      <ul style="font-size: 22px">
        <li>
          Navnekollisjoner
        </li>
      </ul>
      <li>
        Implicit global scope på udeklarerte variable
      </li>
      <li>
        Støtte for closures / "free variables"
      </li>
      <ul style="font-size: 22px">
        <li>
          En funksjon har tilgang til variable fra en ytre funksjon
          selv om den ytre funksjon har returnert
        </li>
      </ul>
    </ul>
  </article>
  
  <article>
    <h3>
      Selveksekvering med lokalt scope
    </h3>
    <pre>
  (function() {
     //snurr film
     //lokale variable havner ikke i global scope
     var name = “Ole”;
     alert(name);
  }());
    </pre>
  </article>

  <article>
    <h3>
      Quiz: Variable vs objekt properties
    </h3>
    <pre>
  function Person() {
      var name = "Per";
      this.name = "Ole";
      alert(name);
      alert(this.name);
  }

  new Person();  //hva alertes?
      <script type="text/javascript">
        function Person() {
            var name = "Per";
            this.name = "Ole";
            alert(name);
            alert(this.name);
        }
      </script>
    </pre>
    <button style="font-size: 28px;" onclick="new Person(); return false;">Prøv!</button>
  </article>

  <article>
    <h3>
      This
    </h3>
    <ul>
      <li>
        this har en dynamisk verdi
      </li>
      <li>
        Dot notation (“method invocation”):
      </li>
      <ul style="font-size: 22px">
        <li>
          circle.area() &nbsp;  //circle blir “this”
        </li>
      </ul>
      <li>
        Ikke dot notation (“function invocation”):
      </li>
      <ul style="font-size: 22px">
        <li>
          add(3, 4) &nbsp; // “this” blir global object (window)
        </li>
      </ul>
      <li>
        Eksplisitt sette this
      </li>
      <ul style="font-size: 22px">
        <li>
          someFunction.call(thisVerdi, arg1, arg2)
        </li>
        <li>
          someFunction.apply(thisVerdi, arguments)
        </li>
      </ul>
    </ul>
  </article>

  <article>
    <h1>
      Nyttige hjelpere
    </h1>
  </article>

  <article>
    <h3>
      Nyttige hjelpere - Bruk av namespace
    </h3>

    <ul>
      <li>
        Problem: globale variabler
      </li>
      <li>
        Løsning: bruk av namespace
      </li>
    </ul>
    <section>
        <pre>
var result = booking.utils.multiply(4, 2));

var booking = {
  namespace : function() {...};
}
        </pre>
    </section>
  </article>

  <article>
    <h3>
      Nyttige hjelpere - Bruk av namespace
    </h3>

    <section>
        <pre>
var utils = booking.namespace("utils");
utils.multiply = function(x, y) {
  return x * y;
};

var result = booking.utils.multiply(4, 2));

var booking = {
  namespace : function() {},
  utils : {
    multiply : function(x,y){ ... }
  }
};
        </pre>
    </section>
  </article>

  <article>
    <h3>
      Nyttige hjelpere - Prototypal Inheritance
    </h3>

    <ul>
      <li>
        Problem: Classical OOP vs. Prototypal OOP
      </li>
      <li>
        Løsning: Object.create();

        Legg merke til at det er et objekt som arver fra et objekt
      </li>
    </ul>
    <section>
        <pre>
var circle = {
  radius : undefined,
  area : function { this.radius * ... },
  circumference : function { this.radius * .... }
}

var myCircle = Object.create(circle);
myCircle.radius = 3;
myCircle.area();
myCircle.circumference();
        </pre>
    </section>

  </article>

  <article>
    <h3>
      Nyttige hjelpere - definere this for en callback
    </h3>

    <ul>
      <li>
        Problem: bruke “this” i en callback vi sender fra oss
      </li>
      <li>
        Løsning: someMethod.bind(this);
      </li>
    </ul>
    <section>
        <pre>
 function init() {
  $('#update').click(handleButtonClick.bind(this));
 }

 function handleButtonClick() {
  this.controller.fetchPrice($('#weight').val());
 }
        </pre>
    </section>
  </article>

  <article>
    <h1>
      Testing
    </h1>
  </article>

  <article>
    <h3>
        Rammeverk
    </h3>
    <ul>
      <li>
        Jasmine
      </li>
      <ul style="font-size: 22px">
        <li>
          BDD rammeverk
        </li>
        <li>
          Specifications and asserts
        </li>
        <li>
          Kjører i nettleser eller i maven
        </li>
        <ul style="font-size: 20px">
          <li>
            ctrl + r
          </li>
          <li>
            mvn test
          </li>
        </ul>
      </ul>
    </ul>
    <pre>
  describe(“Circle”, function() {
    it(“should compute area”, function() {
      var circle = new Circle(1);
      expect(circle.area()).toEqual(3.14);
    });
  });</pre>
  </article>

  <article>
    <h3>
      Sinon
    </h3>
    <ul>
      <li>
        Mock-rammeverk
      </li>
      <li>
        Jasmine integrasjon
      </li>
    </ul>

    <pre>
  //Spy: Capture kall
  var getPriceSpy = sinon.spy();
  dao.getPrice = getPriceSpy;   //bytt ut funksjon
  //....
  expect(getPriceSpy).toHaveBeenCalledWith({ weight : 32});

  //Stub: Returnerer verdier 
  var getPriceStub = sinon.stub().returns(64); 
  priceDao.getPrice = getPriceStub;   //bytt ut funksjon

  //Mock: Verifiserer bruk 
  var daoMock = sinon.mock(priceDao).expects(“getPrice”).once();
  // ...... 
  daoMock.verify(); </pre>
  </article>

  <article>
    <h3>
      Test patterns
    </h3>
    <ul>
      <li>
        Komponenter
      </li>
      <ul style="font-size: 22px">
        <li>
          Objekter med begrenset ansvarsområde
        </li>
        <li>
          Send inn avhengigheter i en init metode
        </li>
        <li>
          Mye metoder som properties
        </li>
        <ul style="font-size: 22px">
          <li>
            Lar seg overstyre / inspisere
          </li>
        </ul>
      </ul>
      <li>
        Fremprovosere ulike caser med diverse input og stub retur verdier
      </li>
      <li>
        Standard testflyt
      </li>
      <ul style="font-size: 22px">
        <li>
          Sett opp spy / stubs / mocks
        </li>
        <li>
          Snurr film!
        </li>
        <li>
          Verifiser resultat / oppførsel
        </li>
      </ul>
    </ul>
  </article>


  <article>
    <h1>
      Eksempel
    </h1>
  </article>

  <article>
    <iframe  src="http://localhost:8080/"></iframe>
  </article>

  <article>
    <h1>
      Ajax
    </h1>
  </article>

  <article>
    <h3>
      Definere en Pris DAO
    </h3>
    <br/>
    <pre>
// Test
it('should be namespaced', function() {
  var dao = Object.create(booking.helpers.priceDao);
  expect(dao).toBeDefined();
});
    </pre>

    <pre>
// Implementasjon
(function() {
  var helpers = booking.namespace("helpers");
  helpers.priceDao = {};
}());
    </pre>
  </article>

  <article>
    <h3>
      Inputvalidering
    </h3>
    <pre>
// Test
it('should reject empty weight', function () {
  expect(function() { dao.getPrice(); }).
      toThrow(new TypeError("Weight must be set"))
});</pre>

    <pre>
// Implementasjon
function getPrice(weight) {
  if (!weight) {
    throw new TypeError("Weight must be set");
  }
}

var helpers = booking.namespace("helpers");
helpers.priceDao = {
  getPrice : getPrice
};</pre>
  </article>

  <article>
    <h3>
      Spying
    </h3>
    <pre>
  //Test    
  it('should invoke ajax with weight as request parameter', function () {
    $.ajax = ajaxSpy = sinon.spy();
    var weight = 3;
    dao.getPrice(weight);

    expect(ajaxSpy).toHaveBeenCalled();

    var ajaxRequestParams = ajaxSpy.callArgument().data;
    expect(ajaxRequestParams).toEqual({ "weight": weight });
  });</pre>

    <pre>
// Implementasjon
function getPrice(weight) {
  ...
  var params = { "weight" : weight };
  $.ajax({
    data: params
  });
}</pre>
  </article>

  <article>
    <h3>
      Verifisere callbacks
    </h3>
    <pre>
  //Test
  it('should invoke successfunction with data from remote service', function () {
    var successFunction = sinon.spy();
    dao.getPrice(3, successFunction);

    var remoteData = { "price" : 9 };
    //simulate jQuery success
    ajaxSpy.getCall(0).args[0].success(remoteData);

    expect(successFunction).toHaveBeenCalledWith(remoteData);
  });</pre>

    <pre>
// Implementasjon
function getPrice(weight, successFunction) {
  ...
  $.ajax({
    data: params,
    success: successFunction
  });
}</pre>
  </article>


  <article>
    <h1>
      Eksempel: Controller + View
    </h1>
  </article>

  <article>
    <br/>
    <br/>
    <br/>
    <br/>
    <p>
      <img src="http://i.imgur.com/VflRP.png"/>
    </p>
  </article>


  <article>
    <h3>View</h3>
    <br/>
    <p>
      <img src="http://i.imgur.com/dYb3n.png" alt="View inndeling"/>
    </p>
  </article>


  <article>
    <br/>
    <br/>
    <img src="http://i.imgur.com/2g9h6.png" width="110%" style="margin-left:-35px;" alt="Diagram"/>
    <br/>
    <ul>
      <li>States</li>
      <ul style="font-size: 22px">
        <li>
          "editing"
        </li>
        <li>
          "priceReady"
        </li>
      </ul>
      <li>Observer pattern</li>
      <ul style="font-size: 22px">
        <li>
          Views kan abonnere på state changes og få ny state data
        </li>
      </ul>

    </ul>
  </article>


  <article>
    <h3>
      Form View
    </h3>
    <br/>

    <p>Test:</p>
    <pre>
  it('should be namespaced', function() {
    var view = Object.create(booking.pricePage.formView);
    expect(view).toBeDefined();
  });
    </pre>

    <p>Impl:</p>
    <pre>
  (function() {
    booking.namespace("pricePage").formView = {}
  }());
    </pre>
  </article>

  <article>
    <p>Test:</p>
    <pre>
  it('should contain init and handleButtonClick methods', function () {
    expect(view.init).toBeDefined();
    expect(view.handleButtonClick).toBeDefined();
  });</pre>

    <p>Impl:</p>
    <pre>
(function() {
  function handleButtonClick() {}

  function init() {}

  booking.namespace("pricePage").formView = {
    init : init,
    handleButtonClick : handleButtonClick
  };
}());</pre>
  </article>

  <article>
    <p>Test:</p>
    <pre>
  it('should invoke controller on button click', function () {

    //setup:
    var controller = Object.create(booking.pricePage.controller);
    controller.fetchPrice = sinon.spy();
    var pageObject = {
      button : $("&lt;button/&gt;"),
      weight : $("&lt;input/&gt;")
    };
    view.init(controller, pageObject);

    //snurr film:
    pageObject.weight.val("10");
    pageObject.button.click();

    //verify:
    expect(controller.fetchPrice).toHaveBeenCalledWith("10");
  });</pre>
  </article>

  <article>
    <p>Form View impl:</p>
    <pre>
  (function() {
    function init(controller, pageObject) {
      this.controller = controller;
      this.pageObject = pageObject;

      pageObject.button.click(this.handleButtonClick.bind(this));
    }

    function handleButtonClick(event) {
      this.controller.fetchPrice(this.pageObject.weight.val());
    }

    booking.namespace("pricePage").formView = {
      init : init,
      handleButtonClick : handleButtonClick
    };
  }());</pre>
  </article>

  <article>
    <h3>View</h3>
    <br/>
    <p>
      <img src="http://i.imgur.com/dYb3n.png"/>
    </p>
  </article>


  <article>
    <h3>Price View</h3>
    <p>Test:</p>
    <pre>
  it('should show price on priceReady event', function () {

      //setup
    var view = Object.create(booking.pricePage.priceView);
    var controller = Object.create(booking.pricePage.controller);
    var pageObject = { priceLabel : $("&lt;span/&gt;") };
    view.init(controller, pageObject);

    //snurr film:
    controller.notify(states.priceReady, { price : 32});

    //verify:
    expect(pageObject.priceLabel.html()).toBe("32");
  });</pre>
  </article>

  <article>
    <p>Price View impl:</p>
    <pre>
(function() {
  var states = booking.pricePage.states;

  function init(controller, pageObject) {
    this.pageObject = pageObject;
    controller.observe(states.priceReady, this.showPrice.bind(this));
  }

  function showPrice(result) {
    this.pageObject.priceLabel.html(result.price);
  }

  booking.namespace("pricePage").priceView = {
    init : init,
    showPrice : showPrice
  };
}());</pre>
  </article>

  <article>
    <iframe  src="http://localhost:8234"></iframe>
  </article>

  <article>
    <h1>
      Lesson learned
    </h1>
  </article>

  <article>
    <h3>
      Lesson learned
    </h3>
    <ul>
      <li>
        Lav terskel for å komme i gang, høy terskel for å skrive god kode
      </li>
      <li>
        Mange fete muligheter i JavaScript
      </li>
      <li>
        Krever at alle på teamet <strong>lærer</strong> seg JavaScript
      </li>
      <li>
      "Utils"-metoder må defineres først
      </li>
      <li>
        Mye lettere å vedlikeholde
      </li>
    </ul>
  </article>

  <article>
    <h3>
      Lesson learned - bøker
    </h3>

    <br/><br/>
    <img style="height: 70%; float:left" src="http://i.imgur.com/ELhA0.jpg"/>
    <img style="height: 70%; float:right" src="http://i.imgur.com/LdVUZ.jpg"/>
  </article>

  <article>
    <h3>
      Oppsummering
    </h3>
    <ul>
      <li>
        Hvorfor gjøre noe annet enn vi gjør i dag?
      </li>
      <li>
        JavaScript fundamenter
      </li>
      <li>
        Nyttige hjelpere
      </li>
      <li>
        Testing
      </li>
      <li>
        Eksempel: Ajax
      </li>
      <li>
        Eksempel: Controller + View
      </li>
      <li>
        Lesson learned
      </li>
    </ul>
  </article>

  <article>
    <h1>
      Takk for oss
    </h1>

    <div class='author'>
      Christian Schwarz og Lars Brandt
    </div>

    <br/><br/>
    <p style="font-size:18px">Presentasjon: <a href="http://larsbrandt.github.com/fagdag">larsbrandt.github.com/fagdag</a></p>
    <p style="font-size:18px">Kildekode: <a href="http://github.com/larsbrandt/fagdag">github.com/larsbrandt/fagdag</a></p>
  </article>


</section>
</body>
</html>
